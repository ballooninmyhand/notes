### 介绍

整数集合（intset）是集合键的底层实现之一，当一个集合只包含整数值元素，并且这个集合的元素数量不多时，Redis 就会使用整数集合作为集合键的底层实现。

整数集合（intset）是Redis用于保存整数值的集合抽象数据结构，它可以保存类型为int16_t、int32_t或者int64_t的整数值，并且保证集合中不会出现重复元素。



### 实现

在 [intset.h/intset](https://github.com/antirez/redis/blob/unstable/src/intset.h) 中定义：

```c
typedef struct intset {
    // 编码方式
    uint32_t encoding;
    // 集合包含的元素数量
    uint32_t length;
    // 保存元素的数组
    int8_t contents[];
} intset;
```

- contents 数组是整数集合的底层实现，每个元素都是 contents 数组的一个数组项（item），各个项在数组中按值的大小从小到大排列，不包含重复项
- length 属性记录了整数集合包含的元素数量，即 contents 数组的长度
- contents 数组的类型取决于 encoding 属性的值。如果 encoding 的值为 `INTSET_ENC_INT16`，那么 contents 数组中每一项都是 int16_t 类型的整数值



### 升级

每当添加新元素到整数集合中，并且新元素的类型比整数集合现有元素类型长时，整数集合需要先升级（upgrade），然后才能添加新元素。

升级整数集合分为三步：

① 根据新元素类型，扩展整数集合底层数组空间大小，并为新元素分配空间

② 将底层数组现有的元素都转换成和新元素相同的类型，并且保持值从小到大的顺序将元素放置到正确的位上

③ 将新元素添加到底层数组里

因为引发升级的新元素长度总是比整数集合现有元素的长度大，所以新元素的值要么大于所有元素，要么小于所有元素：

- 当新元素小于所有现有元素时，新元素会放置在底层数组最开头（索引为 0）
- 当新元素大于所有现有元素时，新元素会放置在底层数组最末尾（索引为 length-1）

**好处**

- 提升灵活性，不必担心类型错误
- 节约内存



### 降级

整数集合不支持降级操作，一旦对数组进行了升级，编码就会一直保持升级后的状态。



### API

以下为整数集合相关 API：

| API           | 作用                           | 时间复杂度                                                   |
| ------------- | ------------------------------ | ------------------------------------------------------------ |
| intsetNew     | 创建一个新的整数集合           | O(1)                                                         |
| intsetAdd     | 将给定元素添加到整数集合里     | O(N)                                                         |
| intsetRemove  | 从整数集合中移除给定元素       | O(N)                                                         |
| intsetFind    | 检查给定值是否存在于整数集合   | 因为底层数组有序，可以通过二分查找，复杂度为O(log<sup>N</sup>>) |
| intsetRandom  | 从整数集合随机返回一个元素     | O(1)                                                         |
| intsetGet     | 取出底层数组在给定索引上的元素 | O(1)                                                         |
| intsetLen     | 返回整数集合包含的元素个数     | O(1)                                                         |
| intsetBlobLen | 返回整数集合占用的内存字节数   | O(1)                                                         |



### 参考

- 《Redis设计与实现》