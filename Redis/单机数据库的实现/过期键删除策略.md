### 过期键删除策略

如果一个键过期了，那么他什么时候会被删除呢？

- 定时删除：在设置键的过期时间的同时，创建一个定时器（timer），让定时器在键的过期时间来临时，立即执行对键的删除操作
- 惰性删除：放任键过期不管，但是每次从键空间中获取键时，都检查取得的键是否过期，如果过期，就删除该键；如果没有过期，就返回该键
- 定期删除：每隔一段时间，程序就对数据库进行一次检查，删除里面的过期键。至于要删除多少过期键，以及要检查多少数据库，则由算法决定

在这三种策略中，第一种和第三种为主动删除策略，第二种则为被动删除策略。

**定时删除**

对内存最友好，对 CPU 最不友好。

通过使用定时器，定时删除策略可以保证过期键尽可能快的被删除，并释放过期键所占用的内存。

在过期键较多的情况下，删除过期键可能会占用一部分 CPU 时间，当 CPU 时间非常紧张时，处理过期键会对服务器的响应时间和吞吐量造成影响

**惰性删除**

对 CPU 最友好，对内存最不友好。

程序只在取出键时对键进行过期检查，不会无端花费 CPU 时间。

如果数据库中存在大量过期键，而且没有被访问到，那么这些键可能永远不会被删除，甚至可以看做是内存泄漏——无用的垃圾数据占用了大量内存。

**定期删除**

定期删除策略是对前两种策略的一种整合和折中：

- 定期删除策略每隔一段时间执行一次删除过期键的操作，并限制了删除操作的执行时长和频率
- 定期删除过期键也有效减少了因为过期键而带来的内存浪费

定期删除策略的难点是确定删除操作执行的时长和频率：

- 如果操作执行的太频繁或者执行时间太长，就退化成定时删除策略
- 如果操作执行的太少或者执行时间太短，就会和惰性删除一样，造成内存浪费

因此，如果采用定期删除策略的话，服务器必须根据情况，合理设置删除操作的执行频率和时长。



### Redis 的过期键删除策略

Redis 服务器采用的是惰性删除和定期删除这两种策略，通过配合使用这两种策略，服务器可以很好的在合理使用 CPU 和避免浪费内存之间取得平衡。

**惰性删除策略的实现**

所有读写数据库的 Redis 命令在执行之前，都会调用 `expirelfNeeded` 函数对输入键进行检查：

- 如果输入键已经过期，那么 `expirelfNeeded` 函数将输入键从数据库中删除
- 如果输入键未过期，那么 `expirelfNeeded` 函数不做动作

**定期删除策略的实现**

过期键的定期删除策略由 `activeExpireCycle` 函数实现，每当 Redis 的服务器周期性操作 `serverCron` 函数执行时，`activeExpireCycle` 函数就会被调用，他在规定时间内，分多次遍历服务器中的各个数据库，从数据库的过期字典中随机检查一部分键的过期时间，并删除其中的过期键。

`activeExpireCycle` 函数的工作模式如下：

- 函数每次运行时，都从一定数量的数据库中取出一定数量的随机键进行检查，并删除其中的过期键
- 全局变量 `current_db` 会记录 `activeExpireCycle` 函数检查的进度，并在下一次函数调用时，接着上一次的进度处理
- 随着 `activeExpireCycle` 函数的不断执行，服务器中所有数据库都会被检查一遍，这是函数将 `current_db` 重置为 0，然后开始新一轮的检查



### RDB、AOF和复制功能对过期键的处理

**生成 RDB 文件**

在执行 SAVE 命令或者 BGSAVE 命令创建一个新的 RDB 文件时，程序会对数据库中的键进行过期检查，已过期的键不会保存到 RDB 文件中

**载入 RDB 文件**

在启动 Redis 服务器时，如果服务器开启了 RDB 功能，那么服务器将对 RDB 文件进行载入：

- 如果服务器以主服务器模式运行，程序会对文件中保存的键进行过期检查，过期键会被忽略，所以过期键对载入 RDB 文件的主服务器没有影响
- 如果服务器以从服务器模式运行，文件中保存的所有键都会载入数据库。不过在主从服务器数据同步时，从服务器的数据会被清空。所以一般来说，过期键对载入 RDB 文件的从服务器也不会造成影响

**AOF 写入**

当服务器以 AOF 持久化模式运行时，如果数据库中某个键已经过期，但它还没被惰性删除或者定期删除，那么 AOF 文件不会因为这个过期键产生任何影响。

当过期键被惰性删除或定期删除后，程序会向 AOF 文件追加一条 DEL 命令，来显式的记录该键已被删除。

**AOF 重写**

执行 AOF 重写时，程序会对数据库中的键进行过期检查，已过期的键不会被保存到重写后的 AOF 文件中。

**复制**

当服务器在复制模式下运行时，从服务器的过期键删除动作由主服务器控制：

- 主服务器删除一个过期键后，会显式的向所有从服务器发送一条 DEL 命令，告知从服务器删除这个过期键
- 从服务器在执行客户端发送的读命令时，即使碰到过期键也不会将过期键删除，而是继续像处理未过期键一样处理过期键
- 从服务器只有在接收到主服务器的 DEL 命令后，才会删除过期键







